<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Refund Request Details</title>
  <style>
    body { background: #f7f8fa; }
    .card-border { border-radius: 10px; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container my-4">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>
    <% if (success && success.length) { %>
      <div class="alert alert-success">
        <% success.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>
    <div class="mb-4">
      <a href="/managerefunds" class="btn btn-outline-secondary mb-3">‚Üê Back to Refunds</a>
      <h2>Refund Request #<%= refund.refundRequestId %></h2>
    </div>

    <div class="row">
      <!-- Customer & Refund Info -->
      <div class="col-md-6">
        <div class="card card-border shadow-sm mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">Customer Information</h5>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <label class="text-muted small">Name</label>
              <div><strong><%= refund.username %></strong></div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Email</label>
              <div><%= refund.email %></div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Order ID</label>
              <div>#<%= refund.purchaseId %></div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Purchase Date</label>
              <div><%= new Date(refund.purchase_date).toLocaleDateString() %></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Refund Amount & Status -->
      <div class="col-md-6">
        <div class="card card-border shadow-sm mb-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">Refund Details</h5>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <label class="text-muted small">Refund Amount</label>
              <div><h4 class="text-success">$<%= Number(refund.refund_amount).toFixed(2) %></h4></div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Status</label>
              <div>
                <% if (refund.status === 'pending') { %>
                  <span class="badge bg-warning text-dark">Pending</span>
                <% } else if (refund.status === 'approved') { %>
                  <span class="badge bg-success">Approved</span>
                <% } else if (refund.status === 'rejected') { %>
                  <span class="badge bg-danger">Rejected</span>
                <% } %>
              </div>
            </div>
            <div class="mb-2">
              <label class="text-muted small">Requested Date</label>
              <div><%= new Date(refund.requested_at).toLocaleString() %></div>
            </div>
            <% if (refund.processed_at) { %>
              <div class="mb-2">
                <label class="text-muted small">Processed Date</label>
                <div><%= new Date(refund.processed_at).toLocaleString() %></div>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Refund Reason -->
    <div class="card card-border shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">Refund Reason</h5>
      </div>
      <div class="card-body">
        <% if (refund.reason) { %>
          <p><%= refund.reason %></p>
        <% } else { %>
          <p><em class="text-muted">No reason provided</em></p>
        <% } %>
      </div>
    </div>

    <!-- Purchase Items -->
    <div class="card card-border shadow-sm mb-3">
      <div class="card-header bg-light">
        <h5 class="mb-0">Order Items</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th style="width:100px">Price</th>
                <th style="width:100px">Qty</th>
                <th style="width:120px">Total</th>
              </tr>
            </thead>
            <tbody>
              <% if (purchase && purchase.items && purchase.items.length > 0) { %>
                <% purchase.items.forEach(function(item) { %>
                  <tr>
                    <td>
                      <div><strong><%= item.productName %></strong></div>
                      <small class="text-muted">Product ID: <%= item.productId %></small>
                    </td>
                    <td>$<%= Number(item.price).toFixed(2) %></td>
                    <td><%= item.quantity %></td>
                    <td>$<%= Number(item.lineTotal).toFixed(2) %></td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr><td colspan="4" class="text-center text-muted">No items in order</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Admin Notes Section -->
    <% if (refund.admin_notes) { %>
      <div class="card card-border shadow-sm mb-3">
        <div class="card-header bg-light">
          <h5 class="mb-0">Admin Notes</h5>
        </div>
        <div class="card-body">
          <p><%= refund.admin_notes %></p>
        </div>
      </div>
    <% } %>

    <!-- Action Buttons -->
    <% if (refund.status === 'pending') { %>
      <div class="d-flex gap-2">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveModal">Approve Refund</button>
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">Reject Refund</button>
        <a href="/managerefunds" class="btn btn-secondary">Back to List</a>
      </div>

      <!-- Approve Modal -->
      <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Approve Refund</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/refund/<%= refund.refundRequestId %>/approve" method="POST">
              <div class="modal-body">
                <p>Approve refund of <strong>$<%= Number(refund.refund_amount).toFixed(2) %></strong> for <strong><%= refund.username %></strong>?</p>
                <p class="text-muted">The refund will be added as store credit to their account.</p>
                <div class="mb-3">
                  <label for="adminNotes" class="form-label">Admin Notes (Optional)</label>
                  <textarea class="form-control" id="adminNotes" name="adminNotes" rows="2"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Approve Refund</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Reject Modal -->
      <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Reject Refund</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/refund/<%= refund.refundRequestId %>/reject" method="POST">
              <div class="modal-body">
                <p>Reject refund request of <strong>$<%= Number(refund.refund_amount).toFixed(2) %></strong> for <strong><%= refund.username %></strong>?</p>
                <div class="mb-3">
                  <label for="rejectNotes" class="form-label">Reason for Rejection</label>
                  <textarea class="form-control" id="rejectNotes" name="adminNotes" rows="2" required placeholder="Please provide a reason..."></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Reject Refund</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% } else { %>
      <a href="/managerefunds" class="btn btn-secondary">Back to List</a>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
