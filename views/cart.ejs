<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .quantity-select { max-width:100px; margin:0 auto; text-align:center; text-align-last:center; }
    .img-thumb { height:64px; object-fit:contain; }
    .empty-msg { padding: 48px 0; font-size:1.1rem; color:#6c757d; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <div class="container my-4">
    <h2>Your Cart</h2>

    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>
    <% if (success && success.length) { %>
      <div class="alert alert-success">
        <% success.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>

    <% 
      const rawItems = typeof items !== 'undefined' ? items : (typeof cart !== 'undefined' ? cart : []);
      const cartItems = Array.isArray(rawItems) ? rawItems.filter(Boolean) : [];
      let computedTotal = 0;
      cartItems.forEach(it => {
        const price = (it && typeof it.price !== 'undefined') ? Number(it.price) : 0;
        const qty = (it && typeof it.quantity !== 'undefined') ? Number(it.quantity) : 0;
        computedTotal += price * qty;
      });
      const displaySubtotal = (typeof subtotal !== 'undefined') ? Number(subtotal) : computedTotal;
      const isEmpty = cartItems.length === 0;
    %>

    <table class="table table-bordered align-middle mt-3">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th>Product</th>
          <th style="width:120px">Image</th>
          <th class="text-end" style="width:120px">Unit Price</th>
          <th class="text-center" style="width:220px">Quantity</th>
          <th class="text-end" style="width:140px">Sub Total</th>
          <th class="text-end" style="width:120px">Action</th>
        </tr>
      </thead>

      <tbody>
        <% if (isEmpty) { %>
          <tr>
            <td colspan="7" class="text-center empty-msg">
              <div>Cart is empty.</div>
            </td>
          </tr>
        <% } else { %>
          <% cartItems.forEach((it, idx) => {
               if (!it) return; // extra guard
               const id = it.cart_itemsId || it.ProductId || it.productId;
               const qty = Number(it.quantity) || 0;
               const price = Number(it.price) || 0;
               const available = (typeof it.availableQuantity !== 'undefined') ? Number(it.availableQuantity) : 0;
               const maxSelectable = Math.max(qty, qty + available); // allow keeping current qty + any remaining stock
          %>
            <tr id="row-<%= id %>">
              <td><%= idx + 1 %></td>
              <td><strong><%= it.productName %></strong></td>
              <td><img src="/images/<%= it.image || 'placeholder.png' %>" alt="" class="img-thumb img-thumbnail"></td>
              <td class="text-end">$<%= price.toFixed(2) %></td>

              <td class="text-center">
                <form action="/cart/update/<%= id %>" method="POST" class="d-flex align-items-center justify-content-center gap-2 update-form" data-id="<%= id %>" data-price="<%= price %>">
                  <select name="quantity" class="form-select quantity-select">
                    <% const maxQ = Math.max(1, maxSelectable);
                       for (let q = 1; q <= maxQ; q++) { %>
                      <option value="<%= q %>" <%= q === qty ? 'selected' : '' %>><%= q %></option>
                    <% } %>
                  </select>
                  <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                </form>
              </td>

              <td class="text-end" id="line-total-<%= id %>">$<%= (price * qty).toFixed(2) %></td>

              <td class="text-end">
                <form action="/cart/remove/<%= id %>" method="POST" class="remove-form" data-id="<%= id %>">
                  <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                </form>
              </td>
            </tr>
          <% }); %>
        <% } %>
      </tbody>

      <tfoot>
        <tr>
          <td colspan="5" class="text-end"><strong>Subtotal</strong></td>
          <td class="text-end"><strong id="subtotal-value">$<%= (isEmpty ? 0 : displaySubtotal).toFixed(2) %></strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="d-flex justify-content-between mt-3">
      <a href="/shopping" class="btn btn-secondary">Continue shopping</a>

      <div>
        <form id="checkout-form" action="/cart/checkout" method="POST" class="d-inline me-2">
          <button class="btn btn-success" <%= isEmpty ? 'disabled' : '' %>>Proceed to checkout</button>
        </form>

        <form id="clear-form" action="/cart/clear" method="POST" class="d-inline">
          <button type="submit" class="btn btn-outline-danger" <%= isEmpty ? 'disabled' : '' %>>Clear cart</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    // AJAX handlers for update & remove â€” updates DOM (line total + subtotal) without full reload
    document.addEventListener('DOMContentLoaded', () => {
      // Update quantity
      document.querySelectorAll('.update-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const id = form.dataset.id;
          const price = Number(form.dataset.price || 0);
          const fd = new FormData(form);
          try {
            const res = await fetch(form.action, { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
            if (!res.ok) { // fallback to full submit
              form.submit();
              return;
            }
            const data = await res.json();
            // data should include cart_itemsId, lineTotal, subtotal
            const lineEl = document.getElementById('line-total-' + data.cart_itemsId);
            if (lineEl) lineEl.textContent = '$' + Number(data.lineTotal).toFixed(2);
            const subEl = document.getElementById('subtotal-value');
            if (subEl) subEl.textContent = '$' + Number(data.subtotal).toFixed(2);

          } catch (err) {
            console.error('Update failed', err);
            form.submit();
          }
        });
      });

      // Remove item
      document.querySelectorAll('.remove-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!confirm('Remove this item from cart?')) return;
          const id = form.dataset.id;
          try {
            const res = await fetch(form.action, { method: 'POST', body: new FormData(form), headers: { 'Accept': 'application/json' } });
            if (!res.ok) {
              // fallback to full submit
              form.submit();
              return;
            }
            const data = await res.json();
            // Expect server to return { removedId: id, subtotal: <number> } or similar
            const row = document.getElementById('row-' + (data.removedId || id));
            if (row) row.remove();
            const subEl = document.getElementById('subtotal-value');
            if (subEl && typeof data.subtotal !== 'undefined') subEl.textContent = '$' + Number(data.subtotal).toFixed(2);

            // if cart empty, reload to show empty message (or you can render empty state client-side)
            const tbody = document.querySelector('table tbody');
            if (!tbody || !tbody.querySelector('tr')) {
              window.location.reload();
            }
          } catch (err) {
            console.error('Remove failed', err);
            form.submit();
          }
        });
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
