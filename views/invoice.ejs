<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Invoice <%= orderId ? ('#' + orderId) : '' %></title>
  <style>
    body { background: #f7f8fa; }
    .card-border { border-radius: 10px; }
    .label { color: #6c757d; font-size: 0.9rem; }
    .table thead th { background-color: #f8f9fa; }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="alert alert-success">
      Payment received. This invoice serves as your receipt.
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Invoice</h2>
        <div class="text-muted">Thank you for your purchase.</div>
      </div>
      <div class="text-end">
        <div class="fw-semibold"><%= orderId || 'Order' %></div>
        <div class="text-muted"><%= generatedAt ? new Date(generatedAt).toLocaleString() : new Date().toLocaleString() %></div>
        <div><span class="badge bg-success">Paid</span></div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <h6 class="mb-2">Bill to</h6>
        <div class="card p-3 card-border shadow-sm">
          <div><strong><%= user ? user.username : 'Guest' %></strong></div>
          <div class="text-muted"><%= user && user.email ? user.email : '' %></div>
          <div class="mt-2">
            <div class="label">Address</div>
            <div><%= user && user.address ? user.address.replace(/\n/g,'<br>') : 'No address provided' %></div>
          </div>
          <div class="mt-2">
            <div class="label">Contact</div>
            <div><%= user && user.contact ? user.contact : 'Not provided' %></div>
          </div>
        </div>
      </div>
      <div class="col-md-6 text-md-end">
        <h6 class="mb-2">Order summary</h6>
        <div class="card p-3 card-border shadow-sm">
          <div class="d-flex justify-content-between">
            <span class="label">Order date</span>
            <span><%= generatedAt ? new Date(generatedAt).toLocaleDateString() : new Date().toLocaleDateString() %></span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="label">Payment method</span>
            <span><%= paymentMethod || 'Not specified' %></span>
          </div>
          <% if (paymentDetails) { %>
            <div class="d-flex justify-content-between">
              <span class="label">Payment details</span>
              <span class="text-muted"><%= paymentDetails %></span>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="table-responsive mb-3">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:48px">#</th>
            <th>Product</th>
            <th style="width:120px">Unit</th>
            <th style="width:120px">Quantity</th>
            <th style="width:140px">Line total</th>
          </tr>
        </thead>
        <tbody>
        <% if (!items || items.length === 0) { %>
          <tr><td colspan="5" class="text-center">No items.</td></tr>
        <% } else { %>
          <% items.forEach(function(item, idx) { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td>
                <div class="d-flex align-items-center">
                  <% if (item.image) { %>
                    <img src="/images/<%= item.image %>" alt="" style="height:48px; width:48px; object-fit:cover; margin-right:8px;">
                  <% } %>
                  <div>
                    <div><strong><%= item.productName || item.name || 'Item' %></strong></div>
                    <small class="text-muted"><%= item.category || '' %></small>
                  </div>
                </div>
              </td>
              <td>$<%= Number(item.price).toFixed(2) %></td>
              <td><%= item.quantity %></td>
              <td>$<%= (item.lineTotal || (item.price * item.quantity)).toFixed(2) %></td>
            </tr>
          <% }); %>
        <% } %>
        </tbody>
      </table>
    </div>

    <div class="row align-items-start">
      <div class="col-md-6">
      </div>
      <div class="col-md-6">
        <table class="table table-borderless mb-0">
          <tbody>
            <tr>
              <th class="text-end">Subtotal</th>
              <td class="text-end">$<%= Number(typeof subtotal !== 'undefined' ? subtotal : 0).toFixed(2) %></td>
            </tr>
            <tr>
              <th class="text-end">Tax</th>
              <td class="text-end">$<%= Number(typeof tax !== 'undefined' ? tax : 0).toFixed(2) %></td>
            </tr>
            <tr>
              <th class="text-end">Shipping</th>
              <td class="text-end">$<%= Number(typeof shipping !== 'undefined' ? shipping : 0).toFixed(2) %></td>
            </tr>
            <% if (typeof voucher !== 'undefined' && voucher && typeof voucherDiscount !== 'undefined' && voucherDiscount > 0) { %>
              <tr>
                <th class="text-end">Voucher (<%= voucher.code %>)</th>
                <th class="text-end text-success">- $<%= Number(voucherDiscount).toFixed(2) %></th>
              </tr>
            <% } %>
            <% if (typeof storeCreditUsed !== 'undefined' && storeCreditUsed > 0) { %>
              <tr>
                <th class="text-end">Store Credit Used</th>
                <th class="text-end text-success">- $<%= Number(storeCreditUsed).toFixed(2) %></th>
              </tr>
            <% } %>
            <tr class="table-active">
              <th class="text-end">Total</th>
              <th class="text-end">$<%= Number(typeof total !== 'undefined' ? total : 0).toFixed(2) %></th>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-3 gap-2">
      <div>
        <a href="/shopping" class="btn btn-outline-secondary">Continue Shopping</a>
        <form action="/purchases/<%= orderId %>/reorder" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-info">Reorder These Items</button>
        </form>
      </div>
      <div>
        <button class="btn btn-primary" onclick="window.print()">Print / Save PDF</button>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#refundModal">Request Refund</button>
      </div>
    </div>

    <!-- Refund Modal -->
    <div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="refundModalLabel">Request Refund</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form action="/refund/request/<%= orderId %>" method="POST">
            <div class="modal-body">
              <p class="text-muted">Request a full refund of <strong>$<%= Number(typeof total !== 'undefined' ? total : 0).toFixed(2) %></strong></p>
              <div class="mb-3">
                <label for="reason" class="form-label">Reason for Refund (Optional)</label>
                <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Please tell us why you're requesting a refund..."></textarea>
              </div>
              <div class="alert alert-info">
                <strong>Note:</strong> Once approved by admin, the refund amount will be added to your store credit for future purchases.
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-warning">Submit Refund Request</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
