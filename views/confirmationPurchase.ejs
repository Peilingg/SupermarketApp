<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title><%= invoice ? 'Invoice' : 'Confirm Purchase' %></title>
  <style>
    .card-border { border-radius: 10px; }
    .badge-soft { background: #eef2f7; color: #0d6efd; }
    .summary-box { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    .table thead th { background-color: #f8f9fa; }
    .label { font-size: 0.9rem; color: #6c757d; }
  </style>
</head>
<body>
  <div class="container my-4">
    <% if (errors && errors.length) { %>
      <div class="alert alert-danger">
        <% errors.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>
    <% if (success && success.length) { %>
      <div class="alert alert-success">
        <% success.forEach(function(msg){ %><div><%= msg %></div><% }); %>
      </div>
    <% } %>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0"><%= invoice ? 'Invoice' : 'Confirm Purchase' %></h2>
      <% if (!invoice) { %>
        <div class="text-end">
          <small class="text-muted">Please review your order before confirming.</small>
        </div>
      <% } else { %>
        <div class="text-end">
          <span class="badge bg-success">Paid</span>
          <div class="text-muted small">Generated: <%= new Date().toLocaleString() %></div>
        </div>
      <% } %>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <h6 class="mb-2">Bill to</h6>
        <div class="card p-3 card-border shadow-sm">
          <div><strong><%= user ? user.username : 'Guest' %></strong></div>
          <div class="text-muted"><%= user && user.email ? user.email : '' %></div>
          <div class="mt-2">
            <div class="label">Address</div>
            <div><%= user && user.address ? user.address.replace(/\\n/g,'<br>') : 'No address provided' %></div>
          </div>
          <div class="mt-2">
            <div class="label">Contact</div>
            <div><%= user && user.contact ? user.contact : 'Not provided' %></div>
          </div>
        </div>
      </div>
      <div class="col-md-6 text-md-end">
        <h6 class="mb-2">Order summary</h6>
        <div class="card p-3 card-border shadow-sm">
          <div class="d-flex justify-content-between">
            <span class="label">Order date</span>
            <span><%= new Date().toLocaleDateString() %></span>
          </div>
          <% if (typeof expectedDelivery !== 'undefined') { %>
            <div class="d-flex justify-content-between">
              <span class="label">Expected delivery</span>
              <span><%= expectedDelivery %></span>
            </div>
          <% } %>
          <div class="d-flex justify-content-between">
            <span class="label">Payment method</span>
            <span id="payment-method-summary"><%= paymentMethod || 'Not specified' %></span>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive mb-3">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:48px">#</th>
            <th>Product</th>
            <th style="width:100px">Unit</th>
            <th style="width:100px">Quantity</th>
            <th style="width:120px">Line total</th>
          </tr>
        </thead>
        <tbody>
        <% if (!items || items.length === 0) { %>
          <tr><td colspan="5" class="text-center">Your cart is empty.</td></tr>
        <% } else { %>
          <% items.forEach(function(item, idx) { %>
            <tr>
              <td><%= idx + 1 %></td>
              <td>
                <div class="d-flex align-items-center">
                  <% if (item.image) { %>
                    <img src="/images/<%= item.image %>" alt="" style="height:48px; width:48px; object-fit:cover; margin-right:8px;">
                  <% } %>
                  <div>
                    <div><strong><%= item.productName || item.name || 'Item' %></strong></div>
                    <small class="text-muted"><%= item.category || '' %></small>
                  </div>
                </div>
              </td>
              <td>$<%= Number(item.price).toFixed(2) %></td>
              <td><%= item.quantity %></td>
              <td>$<%= (item.lineTotal || (item.price * item.quantity)).toFixed(2) %></td>
            </tr>
          <% }); %>
        <% } %>
        </tbody>
      </table>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="mb-3 summary-box">
          <h6>Payment</h6>
          <% 
            const methods = paymentMethods || ['Credit/Debit card', 'Contactless payment (Apple Pay)', 'PayNow', 'PayPal', 'NETS QR'];
            const selectedMethod = paymentMethod || methods[0];
          %>
          <% if (!invoice) { %>
            <div class="list-group">
              <% methods.forEach(function(m) { %>
                <label class="list-group-item d-flex align-items-center">
                  <input class="form-check-input me-2 payment-choice" type="radio" name="paymentMethod" value="<%= m %>" form="confirm-form" <%= m === selectedMethod ? 'checked' : '' %>>
                  <div>
                    <div class="fw-semibold"><%= m %></div>
                    <% if (m === 'PayNow') { %><small class="text-muted">PayNow UEN: 20241234A</small><% } %>
                    <% if (m === 'PayPal') { %><small class="text-muted">Secure PayPal checkout</small><% } %>
                    <% if (m === 'NETS QR') { %><small class="text-muted">Scan QR code with your bank app</small><% } %>
                  </div>
                </label>
              <% }); %>
            </div>
          <% } else { %>
            <p class="mb-1"><strong><%= selectedMethod %></strong></p>
            <% if (paymentDetails) { %>
              <small class="text-muted"><%= paymentDetails %></small>
            <% } %>
          <% } %>
          <p class="text-muted small mb-0 mt-2">By confirming you agree to our terms and authorize the payment.</p>
        </div>
      </div>
      <div class="col-md-6">
        <table class="table table-borderless">
          <tbody>
            <tr>
              <th class="text-end">Subtotal</th>
              <td class="text-end" id="subtotal-amount">$<%= Number(typeof subtotal !== 'undefined' ? subtotal : 0).toFixed(2) %></td>
            </tr>
            <tr>
              <th class="text-end">Tax</th>
              <td class="text-end" id="tax-amount">$<%= Number(typeof tax !== 'undefined' ? tax : 0).toFixed(2) %></td>
            </tr>
            <tr>
              <th class="text-end">Shipping</th>
              <td class="text-end" id="shipping-amount">$<%= Number(typeof shipping !== 'undefined' ? shipping : 0).toFixed(2) %></td>
            </tr>
            <% if (!invoice) { %>
              <% 
                const userStoreCredit = Number(user && user.store_credit ? user.store_credit : 0);
              %>
              <% if (userStoreCredit > 0) { %>
                <tr>
                  <th class="text-end">
                    <div class="form-check form-switch d-inline-flex align-items-center">
                      <input class="form-check-input me-2" type="checkbox" id="useStoreCreditToggle" style="cursor: pointer;">
                      <label class="form-check-label" for="useStoreCreditToggle" style="cursor: pointer;">Use Store Credit</label>
                    </div>
                    <div><small class="text-muted">Available: $<%= userStoreCredit.toFixed(2) %></small></div>
                  </th>
                  <th class="text-end text-success" id="store-credit-discount" style="display: none;">- $<span id="store-credit-amount">0.00</span></th>
                </tr>
              <% } %>
            <% } %>
            <% if (voucher) { %>
              <tr>
                <th class="text-end">Voucher (<%= voucher.code %>)</th>
                <th class="text-end text-success">- $<%= Number(typeof voucherDiscount !== 'undefined' ? voucherDiscount : 0).toFixed(2) %></th>
              </tr>
            <% } %>
            <tr class="table-active">
              <th class="text-end">Total</th>
              <th class="text-end" id="total-amount">$<%= Number(typeof total !== 'undefined' ? total : 0).toFixed(2) %></th>
            </tr>
          </tbody>
        </table>

        <% if (!invoice) { %>
          <div class="mb-2">
            <% if (voucher && voucherDiscount === 0 && voucherReason) { %>
              <div class="alert alert-warning py-2 mb-2">Voucher applied but not eligible: <%= voucherReason %>.</div>
            <% } %>
            <a href="/vouchers" class="btn btn-outline-primary w-100 mb-2">Manage vouchers</a>
          </div>
          <form id="confirm-form" action="/checkout/confirm" method="POST">
            <% /* include a simple CSRF/token field here if you use one */ %>
            <% if (orderId) { %>
              <input type="hidden" name="orderId" value="<%= orderId %>">
            <% } %>
            <input type="hidden" name="useStoreCredit" id="useStoreCreditInput" value="false">
            <input type="hidden" name="storeCreditUsed" id="storeCreditUsedInput" value="0">
            <button type="submit" class="btn btn-success w-100">Confirm & Pay</button>
          </form>
          <a href="/cart" class="btn btn-outline-secondary w-100 mt-2">Edit Cart</a>
        <% } else { %>
          <div class="alert alert-success text-center">Payment confirmed. Your invoice is ready.</div>
          <a href="/shopping" class="btn btn-primary w-100">Continue Shopping</a>
        <% } %>
      </div>
    </div>
  </div>
  <% if (!invoice) { %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const summaryEl = document.getElementById('payment-method-summary');
      const radios = document.querySelectorAll('.payment-choice');
      const confirmForm = document.getElementById('confirm-form');
      const paymentBtn = document.getElementById('paymentBtn');

      // Store credit toggle handling
      const storeCreditToggle = document.getElementById('useStoreCreditToggle');
      const storeCreditDiscountRow = document.getElementById('store-credit-discount');
      const storeCreditAmountSpan = document.getElementById('store-credit-amount');
      const totalAmountEl = document.getElementById('total-amount');
      const useStoreCreditInput = document.getElementById('useStoreCreditInput');
      const storeCreditUsedInput = document.getElementById('storeCreditUsedInput');

      if (storeCreditToggle) {
        // Data values from EJS
        const subtotal = <%= (typeof subtotal !== 'undefined' ? subtotal : 0) %>;
        const tax = <%= (typeof tax !== 'undefined' ? tax : 0) %>;
        const shipping = <%= (typeof shipping !== 'undefined' ? shipping : 0) %>;
        const voucherDiscount = <%= (typeof voucherDiscount !== 'undefined' ? voucherDiscount : 0) %>;
        const availableCredit = <%= (user && user.store_credit ? user.store_credit : 0) %>;
        const baseTotal = subtotal + tax + shipping - voucherDiscount;

        storeCreditToggle.addEventListener('change', function() {
          if (this.checked) {
            const creditToUse = Math.min(availableCredit, baseTotal);
            const newTotal = Math.max(0, baseTotal - creditToUse);
            storeCreditAmountSpan.textContent = creditToUse.toFixed(2);
            storeCreditDiscountRow.style.display = '';
            totalAmountEl.textContent = '$' + newTotal.toFixed(2);
            useStoreCreditInput.value = 'true';
            storeCreditUsedInput.value = creditToUse.toFixed(2);
          } else {
            storeCreditDiscountRow.style.display = 'none';
            totalAmountEl.textContent = '$' + baseTotal.toFixed(2);
            useStoreCreditInput.value = 'false';
            storeCreditUsedInput.value = '0';
          }
        });
      }

      radios.forEach(r => {
        r.addEventListener('change', function() {
          if (this.checked && summaryEl) summaryEl.textContent = this.value;
        });
      });

      if (confirmForm && paymentBtn) {
        confirmForm.addEventListener('submit', function(e) {
          const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
          if (selectedMethod && selectedMethod.value === 'PayPal') {
            e.preventDefault();
            window.location.href = '/checkout/confirm';
          }
        });
      }
    });
  </script>
  <% } %>
</body>
</html>
